#!/bin/sh

echo "üîç Running pre-commit hook to check the code looks good... üîç"

# Load NVM if available (useful for managing Node.js versions)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Ensure `pnpm` is available
echo "Checking if pnpm is available..."
if ! command -v pnpm >/dev/null 2>&1; then
    echo "‚ùå pnpm not found! Please ensure pnpm is installed and available in PATH."
    exit 1
fi

# Run typecheck
echo "Running typecheck..."
if ! pnpm typecheck; then
    echo "‚ùå Type checking failed! Please review TypeScript types."
    echo "Once you're done, don't forget to add your changes to the commit! üöÄ"
    exit 1
fi

# Run lint
echo "Running lint..."
if ! pnpm lint; then
    echo "‚ùå Linting failed! Run 'pnpm lint:fix' to fix the easy issues."
    echo "Once you're done, don't forget to add your beautification to the commit! ü§©"
    exit 1
fi

# Check if commit will have sign-off by checking the process tree
echo "Checking for sign-off in commit..."

# Walk up the process tree to find the git commit command
sign_off_found=false
current_pid=$$

for i in $(seq 1 10); do  # Limit to 10 levels up
    if [ -z "$current_pid" ] || [ "$current_pid" = "1" ]; then
        break
    fi
    
    # Get parent PID
    parent_pid=$(ps -o ppid= -p "$current_pid" 2>/dev/null | tr -d ' ')
    if [ -z "$parent_pid" ]; then
        break
    fi
    
    # Get command line of parent process
    cmd_line=$(ps -o args= -p "$parent_pid" 2>/dev/null | head -1)
    
    # Check if this is a git commit command with -s flag
    if echo "$cmd_line" | grep -q "git.*commit"; then
        if echo "$cmd_line" | grep -qE "(-s|--signoff)"; then
            sign_off_found=true
            break
        else
            echo "‚ùå Found git commit command but no sign-off flag detected."
            break
        fi
    fi
    
    current_pid="$parent_pid"
done

if [ "$sign_off_found" = "false" ]; then
    echo "‚ùå Commit is not signed off! Please use 'git commit -s' to sign off your commit."
    echo "Example: git commit -s -m 'your commit message'"
    echo "This adds a 'Signed-off-by' line to indicate you have read and agreed to the project's contribution guidelines."
    exit 1
fi

echo "üëç All checks passed! Committing changes..."
