name: GitMesh CE Governance Sync

on:
  schedule:
    - cron: '0 0 * * *' 
  pull_request:
    types: [closed]
    paths:
      - 'governance/contributors.yaml'
  push:
    branches:
      - main
    paths-ignore:
      - 'governance/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-engine:
    # Run on schedule, manual trigger, push to main, or merged PR
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install PyYAML requests

      - name: Execute Governance Logic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python .github/scripts/governance_engine.py

      # Create a PR with updates instead of pushing directly to main
      - name: Commit and Create/Update PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add governance/
          
          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to governance files"
            exit 0
          fi
          
          # Check if an open governance sync PR already exists (search by title pattern)
          EXISTING_PR=$(gh pr list --base main --state open --json number,title --jq '.[] | select(.title | startswith("chore(gov): auto-sync")) | .number' | head -1 || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "An open governance sync PR already exists (PR #$EXISTING_PR). Skipping PR creation."
            exit 0
          fi
          
          # Create a unique branch for governance updates
          BRANCH_NAME="governance-sync-$(date +%Y%m%d-%H%M%S)"
          
          git checkout -b "$BRANCH_NAME"
          git commit -s -m "chore(gov): auto-sync activity and history logs" \
            -m "Auto-generated governance update triggered by workflow run." \
            -m "Signed-off-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          
          git push origin "$BRANCH_NAME"
          
          # Create PR using GitHub CLI with better error handling
          PR_TITLE="chore(gov): auto-sync activity and history logs"
          PR_BODY="**Automated governance sync**

          This PR contains automated updates to the governance registry and history logs.

          - Updated contributor activity status
          - Synced recent contributions (PRs, reviews, comments)
          - Maintained historical audit trail

          _This is an automated PR created by the governance sync workflow._"
          
          # Try to create PR with labels first, fall back to no labels if they don't exist
          PR_CREATED=false
          
          # Attempt with labels
          if gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "governance" \
            --label "automated" 2>/tmp/pr_error_labels.log; then
            PR_CREATED=true
          elif grep -q "label.*not found" /tmp/pr_error_labels.log 2>/dev/null; then
            # Labels don't exist, try without them
            echo "Warning: Labels 'governance' or 'automated' not found. Creating PR without labels..."
            if gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME" 2>/tmp/pr_error_nolabels.log; then
              PR_CREATED=true
            fi
          fi
          
          if [ "$PR_CREATED" = false ]; then
            echo "ERROR: Failed to create PR."
            echo "=== First attempt (with labels) ==="
            cat /tmp/pr_error_labels.log 2>/dev/null || echo "No error log from first attempt"
            echo "=== Second attempt (without labels) ==="
            cat /tmp/pr_error_nolabels.log 2>/dev/null || echo "No error log from second attempt"
            exit 1
          fi
          
          echo "Successfully created governance sync PR"