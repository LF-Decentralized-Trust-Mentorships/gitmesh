name: GitMesh CE Governance Sync

on:
  schedule:
    - cron: '0 0 * * *' 
  pull_request:
    types: [closed]
    paths:
      - 'governance/contributors.yaml'
  push:
    branches:
      - main
    paths-ignore:
      - 'governance/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-engine:
    # Run on schedule, manual trigger, push to main, or merged PR
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install PyYAML requests

      - name: Execute Governance Logic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python .github/scripts/governance_engine.py

      # Using the standard GitHub Action bot email and -s for DCO
      - name: Commit and Push Updates
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add governance/
          
          git diff --quiet && git diff --staged --quiet || (git commit -s -m "chore(gov): auto-sync activity and history logs [skip ci]" && git push)